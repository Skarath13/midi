<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Music Transcription</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Klee One', cursive;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 50%, #F0E68C 100%);
            min-height: 100vh;
        }
        
        .note-display {
            font-family: monospace;
            font-size: 2rem;
            min-height: 3rem;
        }
        
        .keyboard-key {
            transition: all 0.1s;
        }
        
        .keyboard-key.active {
            background-color: #8B5CF6;
            transform: translateY(2px);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .recording {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-white mb-4 drop-shadow-lg">
                üé§ Real-time Transcription
            </h1>
            <p class="text-xl text-white/90 drop-shadow">Play music and see notes appear instantly!</p>
            <a href="/" class="text-white/80 hover:text-white underline mt-2 inline-block">
                ‚Üê Back to Upload
            </a>
        </div>

        <div class="max-w-4xl mx-auto bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8">
            <!-- Control Panel -->
            <div class="text-center mb-8">
                <div class="inline-flex gap-4 mb-6">
                    <button id="startBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full transition-all">
                        ‚ñ∂Ô∏è Start
                    </button>
                    <button id="stopBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full transition-all" disabled>
                        ‚èπÔ∏è Stop
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="mode" value="monophonic" checked class="mr-2">
                        <span class="mr-4">Monophonic</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="mode" value="polyphonic" class="mr-2">
                        <span>Polyphonic</span>
                    </label>
                </div>
            </div>

            <!-- Real-time Display -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Note</h3>
                <div id="noteDisplay" class="note-display text-center text-purple-600">
                    --
                </div>
                <div id="frequencyDisplay" class="text-center text-gray-600 mt-2">
                    -- Hz
                </div>
            </div>

            <!-- Visual Keyboard -->
            <div class="bg-gray-100 rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Visual Keyboard</h3>
                <div id="keyboard" class="flex justify-center gap-1 overflow-x-auto">
                    <!-- Keyboard will be generated by JavaScript -->
                </div>
            </div>

            <!-- Chord Display -->
            <div id="chordSection" class="bg-gradient-to-r from-green-50 to-yellow-50 rounded-2xl p-6 mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Detected Chord</h3>
                <div id="chordDisplay" class="text-2xl text-center text-green-600 font-bold">
                    --
                </div>
            </div>

            <!-- Note History -->
            <div class="bg-blue-50 rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Note History</h3>
                <div id="noteHistory" class="max-h-40 overflow-y-auto space-y-1">
                    <p class="text-gray-500 text-sm">Notes will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let pollInterval = null;
        const noteHistory = [];
        const maxHistory = 20;

        // Create visual keyboard
        const keyboard = document.getElementById('keyboard');
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // Create 2 octaves of keys
        for (let octave = 4; octave <= 5; octave++) {
            for (let i = 0; i < noteNames.length; i++) {
                const key = document.createElement('div');
                const noteName = noteNames[i];
                const isBlack = noteName.includes('#');
                
                key.className = `keyboard-key ${isBlack ? 'bg-gray-800 text-white h-12' : 'bg-white h-16'} w-8 rounded flex items-center justify-center text-xs border`;
                key.textContent = noteName;
                key.id = `key-${noteName}${octave}`;
                keyboard.appendChild(key);
            }
        }

        // Start button
        document.getElementById('startBtn').addEventListener('click', async () => {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            try {
                const response = await fetch('/api/realtime/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                
                if (response.ok) {
                    isRunning = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('startBtn').classList.add('recording');
                    
                    // Start polling for results
                    pollInterval = setInterval(pollResults, 100);
                }
            } catch (error) {
                console.error('Error starting transcription:', error);
            }
        });

        // Stop button
        document.getElementById('stopBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/realtime/stop', { method: 'POST' });
                
                isRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('startBtn').classList.remove('recording');
                
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
            } catch (error) {
                console.error('Error stopping transcription:', error);
            }
        });

        // Poll for results
        async function pollResults() {
            if (!isRunning) return;
            
            try {
                const response = await fetch('/api/realtime/results');
                const data = await response.json();
                
                if (data.results) {
                    for (const result of data.results) {
                        handleResult(result);
                    }
                }
            } catch (error) {
                console.error('Error polling results:', error);
            }
        }

        // Handle transcription results
        function handleResult(result) {
            if (result.type === 'pitch') {
                const noteNum = result.data.pitch;
                const noteName = noteNames[noteNum % 12];
                const octave = Math.floor(noteNum / 12) - 1;
                const fullNote = `${noteName}${octave}`;
                
                // Update displays
                document.getElementById('noteDisplay').textContent = fullNote;
                document.getElementById('frequencyDisplay').textContent = `${result.data.frequency.toFixed(1)} Hz`;
                
                // Update keyboard
                document.querySelectorAll('.keyboard-key').forEach(key => {
                    key.classList.remove('active');
                });
                const keyElement = document.getElementById(`key-${noteName}${octave}`);
                if (keyElement) {
                    keyElement.classList.add('active');
                }
                
                // Add to history
                addToHistory(fullNote);
                
            } else if (result.type === 'chord') {
                document.getElementById('chordSection').classList.remove('hidden');
                document.getElementById('chordDisplay').textContent = result.data.chord;
                
            } else if (result.type === 'polyphonic') {
                const notes = result.data.pitches.map(p => {
                    const n = noteNames[p % 12];
                    const o = Math.floor(p / 12) - 1;
                    return `${n}${o}`;
                });
                
                document.getElementById('noteDisplay').textContent = notes.join(', ');
                
                // Update keyboard for multiple notes
                document.querySelectorAll('.keyboard-key').forEach(key => {
                    key.classList.remove('active');
                });
                
                notes.forEach(fullNote => {
                    const match = fullNote.match(/([A-G]#?)(\d+)/);
                    if (match) {
                        const keyElement = document.getElementById(`key-${match[1]}${match[2]}`);
                        if (keyElement) {
                            keyElement.classList.add('active');
                        }
                    }
                });
                
                addToHistory(notes.join(' + '));
            }
        }

        // Add note to history
        function addToHistory(note) {
            const time = new Date().toLocaleTimeString();
            noteHistory.unshift({ time, note });
            
            if (noteHistory.length > maxHistory) {
                noteHistory.pop();
            }
            
            // Update history display
            const historyDiv = document.getElementById('noteHistory');
            historyDiv.innerHTML = noteHistory.map(item => 
                `<p class="text-sm"><span class="text-gray-500">${item.time}</span> - <span class="font-semibold">${item.note}</span></p>`
            ).join('');
        }
    </script>
</body>
</html>